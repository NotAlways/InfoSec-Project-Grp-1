<!DOCTYPE html>
<html>

<head>
    <title>NoteVault Admin</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        /* --- UI Consistency & Styling --- */
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stats-box {
            background: #f4f7f6;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #2c3e50;
            flex: 1;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stats-box span {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        td {
            padding: 12px;
            border: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            margin-right: 5px;
            font-weight: bold;
        }

        .btn-unlock {
            background-color: #27ae60;
        }

        .btn-ban {
            background-color: #c0392b;
        }

        .btn-reset {
            background-color: #7f8c8d;
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* --- Modern Toast Notifications --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            min-width: 280px;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .toast-success {
            background-color: #27ae60;
            border-left: 6px solid #1e8449;
        }

        .toast-error {
            background-color: #c0392b;
            border-left: 6px solid #922b21;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-fade-out {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>

    <nav class="navbar">
        <div class="nav-brand">NoteVault Admin</div>
        <ul class="nav-links">
            <li><a href="#" onclick="window.location.reload()">Refresh Data</a></li>
            <li><a href="/home">User Dashboard</a></li>
            <li><a href="javascript:void(0)" onclick="logout()">Logout</a></li>
        </ul>
    </nav>

    <div class="section">
        <h2>User Management</h2>

        <div class="stats-container">
            <div class="stats-box">Total Users <span id="totalCount">0</span></div>
            <div class="stats-box">Active <span id="activeCount">0</span></div>
            <div class="stats-box">Restricted <span id="lockedCount">0</span></div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: stretch;">
            <input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Search by name or email..."
                style="flex: 2; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">

            <select id="roleFilter" onchange="filterUsers()"
                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">All Roles</option>
                <option value="user">User</option>
                <option value="admin">Admin</option>
                <option value="superadmin">Superadmin</option>
            </select>

            <select id="statusFilter" onchange="filterUsers()"
                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="locked">Locked</option>
                <option value="banned">Banned</option>
            </select>

            <button class="btn-reset" onclick="resetFilters()">Reset</button>
        </div>

        <hr>

        <div id="tableWrapper">
            <p id="msg">Loading account data...</p>
        </div>

        <hr>
        <h3>Recent Activity</h3>
        <div id="activityWrapper"><p>Loading activity...</p></div>

        <h3>Anomaly Detection</h3>
        <div id="anomalyWrapper"><p>Loading anomaly model status...</p></div>
    </div>

    <script>
        // UI Helper: Show Toast Notification
        function showToast(message, type = "success") {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <span style="cursor:pointer; font-size: 20px; margin-left: 15px;" onclick="this.parentElement.remove()">&times;</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add("toast-fade-out");
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        async function readJsonSafely(res) {
            try { return await res.json(); } catch { return null; }
        }

        (function () {
            document.addEventListener("DOMContentLoaded", loadTableData);

            async function loadTableData() {
                const wrapper = document.getElementById("tableWrapper");
                try {
                    const response = await fetch("/admin/list-users");
                    if (!response.ok) throw new Error("Permission Denied (403)");

                    const users = await response.json();
                    if (!users || users.length === 0) {
                        wrapper.innerHTML = "No accounts found.";
                        return;
                    }

                    let tableHtml = `<table id="adminTable">
                        <thead><tr>
                          <th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th>
                        </tr></thead><tbody>`;

                    users.forEach(u => {
                        const statusColor = u.status.toLowerCase() === 'active' ? '#27ae60' : '#c0392b';
                        const displayRole = u.role.charAt(0).toUpperCase() + u.role.slice(1);
                        const displayStatus = u.status.charAt(0).toUpperCase() + u.status.slice(1);

                        tableHtml += `<tr>
                          <td>${u.username}</td>
                          <td>${u.email}</td>
                          <td>${displayRole}</td>
                          <td style="color:${statusColor}; font-weight:bold">${displayStatus}</td>
                          <td>
                            <button class="btn-action btn-unlock" onclick="adminAction('${u.email}', 'unlock')">Unlock</button>
                            <button class="btn-action btn-ban" onclick="adminAction('${u.email}', 'ban')">Ban</button>
                          </td>
                        </tr>`;
                    });

                    tableHtml += `</tbody></table>`;
                    wrapper.innerHTML = tableHtml;
                    updateStats();
                } catch (e) {
                    wrapper.innerHTML = `<p style="color:red">Error: ${e.message}. Are you logged in as Admin?</p>`;
                }
            }

            window.filterUsers = function () {
                const searchVal = document.getElementById("userSearch").value.toLowerCase().trim();
                const roleVal = document.getElementById("roleFilter").value.toLowerCase();
                const statusVal = document.getElementById("statusFilter").value.toLowerCase();
                const rows = document.querySelectorAll("#adminTable tbody tr");

                rows.forEach(row => {
                    const uName = row.cells[0].textContent.toLowerCase();
                    const uEmail = row.cells[1].textContent.toLowerCase();
                    const uRole = row.cells[2].textContent.toLowerCase();
                    const uStatus = row.cells[3].textContent.toLowerCase();

                    const matchSearch = searchVal === "" || uName.includes(searchVal) || uEmail.includes(searchVal);
                    const matchRole = roleVal === "all" || uRole === roleVal;
                    const matchStatus = statusVal === "all" || uStatus === statusVal;

                    row.style.display = (matchSearch && matchRole && matchStatus) ? "" : "none";
                });
                updateStats();
            };

            window.updateStats = function () {
                const rows = document.querySelectorAll("#adminTable tbody tr");
                let total = 0, active = 0, restricted = 0;

                rows.forEach(row => {
                    if (row.style.display !== "none") {
                        total++;
                        const statusText = row.cells[3].textContent.toLowerCase();
                        if (statusText.includes("active")) active++;
                        else restricted++;
                    }
                });

                document.getElementById("totalCount").innerText = total;
                document.getElementById("activeCount").innerText = active;
                document.getElementById("lockedCount").innerText = restricted;
            };

            window.resetFilters = function () {
                document.getElementById("userSearch").value = "";
                document.getElementById("roleFilter").value = "all";
                document.getElementById("statusFilter").value = "all";
                filterUsers();
            };

            window.adminAction = async function (email, action) {
                if (!confirm(`Confirm: ${action.toUpperCase()} ${email}?`)) return;
                try {
                    const res = await fetch(`/admin/manage?target=${encodeURIComponent(email)}&action=${action}`, { method: "POST" });
                    const data = await readJsonSafely(res);

                    if (res.ok) {
                        showToast((data && (data.msg || data.message)) || "Database updated successfully", "success");
                        loadTableData();
                    } else {
                        showToast((data && (data.detail || data.message)) || `Action failed (${res.status})`, "error");
                    }
                } catch (err) {
                    showToast("Network Error: Check server connection", "error");
                }
            };

            async function loadActivity() {
                const wrapper = document.getElementById('activityWrapper');
                try {
                    const res = await fetch('/admin/activity?limit=15');
                    if (!res.ok) throw new Error('Failed to fetch activity');
                    const rows = await res.json();
                    if (!rows || rows.length === 0) {
                        wrapper.innerHTML = '<p>No recent activity.</p>';
                        return;
                    }
                    let html = '<table><thead><tr><th>Time</th><th>Email</th><th>Action</th><th>IP</th><th>Success</th></tr></thead><tbody>';
                    rows.forEach(r => {
                        html += `<tr><td>${r.login_time || ''}</td><td>${r.email || ''}</td><td>${r.action || ''}</td><td>${r.ip_address || ''}</td><td>${r.success}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    wrapper.innerHTML = html;
                } catch (e) {
                    wrapper.innerHTML = `<p style="color:red">${e.message}</p>`;
                }
            }

            async function loadAnomaly() {
                const wrapper = document.getElementById('anomalyWrapper');
                try {
                    const res = await fetch('/admin/anomaly');
                    if (!res.ok) throw new Error('Failed to fetch anomaly status');
                    const info = await res.json();
                    wrapper.innerHTML = info.model_exists ? `<p>Model present (modified: ${new Date(info.modified_at*1000).toLocaleString()})</p>` : '<p>No trained anomaly model found.</p>';
                } catch (e) {
                    wrapper.innerHTML = `<p style="color:red">${e.message}</p>`;
                }
            }

            // enhance loadTableData to also load activity & anomaly
            const originalLoad = loadTableData;
            loadTableData = async function() { await originalLoad(); await loadActivity(); await loadAnomaly(); };

            window.loadTableData = loadTableData;
        })();

        function logout() {
            if (confirm("Are you sure you want to log out of NoteVault?")) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = "/logout";
            }
        }
    </script>
</body>

</html>